# WebRTC

## WebRTC란?

WebRTC가 실시간으로 웹에서 데이터를 교환할 수 있는 이유:

- 시그널링이라고 일컬어지는 NAT 우회 과정을 거치기 때문!



WebRTC의 정의:

> Web Real-Time Communication
>
> 웹 애플리케이션과 사이트가 중간자 없이 브라우저 간에 오디오나 영상 미디어를 포착하고 마음대로 스트림할 뿐 아니라, 임의의 데이터도 교환할 수 있도록 하는 기술

![webRTC](https://wormwlrm.github.io/img/posts/2021-01-24/2.png)

요약하자면, 드라이버나 플러그인 설치 없이 웹 브라우저간 P2P 연결을 통해 데이터 교환을 가능하게 하는 기술!



화상 통화, 실시간 스트리밍, 파일 공유, 스크린 공유 등의 기술들이 WebRTC를 기반으로 하고 있음.



P2P 연결:

- 중개 서버를 거치지 않기 때문에 빠른 속도가 보장됨.
- HTTPS가 강제됨 => 중간자 공격에 대한 보안이 보장됨.
- 실시간 상호작용



## WebRTC의 브라우저 호환성

![webrtc_browser](https://wormwlrm.github.io/img/posts/2021-01-24/3.png)

구글이 주도한 오픈소스 프로젝트 기반 => 크롬(Chrome)에서 호환성이 높다.

아직까지 다양한 플랫폼에서 표준화가 완전히 구현되지는 않았다.



이런 크로스 브라우징 이슈 해결? => adapter.js 라이브러리



#### adapter.js?

- shim 패턴 및 폴리필을 이용해 다양한 브라우저에서 발생할 수 있는 크로스 브라우징 이슈를 사전에 처리해줌
- 벤더 프리픽스를 신경쓸 필요 없이 동일한 API를 호출할 수 있게 만들어줌 => 코드 컨벤션 유지, 개발 생산성 향상



#### 결론:

WebRTC는 단일 브라우저 벤더에서 제공하는 API가 아니며, 브라우저와 운영체제별로 개발되는 속도와 지원되는 버전이 다르므로 호환성과 상호 운용성을 항상 체크해야 한다.



## P2P 절차

1. 각 브라우저가 P2P 커뮤니케이션에 동의
2. 서로의 주소를 공유
3. 보안 사항 및 방화벽 우회
4. 멀티미디어 데이터를 실시간으로 교환

2, 3번 단계는 일반적인 웹 개발의 접근 방법으로는 해결하기 어려움

브라우저는 웹 서버가 아님 => 외부에서 접근할 수 있는 주소가 없기 때문!

=> 통신 설정 초기 단계에서 중재자의 역할이 필요함



## 방화벽, NAT 트래버셜

일반적인 컴퓨터에 공인 IP가 할당되어 있지 않은 이유:

- 방화벽(Firewall)
- NAT: 여러 대의 컴퓨터가 하나의 공인 IP를 공유
- DHCP: 유휴 상태의 IP를 일시적으로 임대받음

사설 IP 주소까지 알아야 특정한 사용자를 지정할 수 있음.



NAT 트래버셜(NAT traversal):

- 라우터를 통과해서 연결할 방법을 찾는 과정



### STUN, TURN

![stun_turn](https://wormwlrm.github.io/img/posts/2021-01-24/1.png)

STUN(Session Traversal Utilities for NAT) 방식:

- 단말이 자신의 공인 IP 주소와 포트를 확인하는 과정에 대한 프로토콜
- WebRTC 연결을 시작하기 전에 STUN 서버를 향해 요청 => NAT 뒤에 있는 피어(Peer)들이 서로 연결할 수 있도록 공인 IP와 포트를 찾아줌

But, 라우터마다 다를 수도 있는 방화벽 정책, 이전에 연결된 적이 있는 네트워크만 연결할 수 있게 제한을 걸면(Symmetric NAT) 정보를 알아낼 수 없음.

=> TURN(Traversal Using Relay NAT) 서버!

네트워크 미디어를 중개하는 서버를 이용하는 방식

- 중간에 서버를 한 번 거치기 떄문에 구조상 지연이 필연적으로 발생 & 엄밀히 P2P통신이 아니게 됨
- 보안 정책이 엄격한 개인 NAT 내부에 위치한 브라우저와 P2P 통신을 할 수 있는 유일한 방법
- 따라서, 최후의 수단으로 선택되어야 함.



## ICE, Candidate

### Candidate(후보):

STUN, TURN 서버를 이용해서 획득했던 IP 주소와 프로토콜, 포트의 조합으로 구성된 연결 가능한 네트워크 주소들 => 후보 찾기(Finding Candidate)



#### Finding Candidate의 결과물

- 자신의 사설 IP와 포트 넘버
- 자신의 공인 IP와 포트 넘버(STUN, TURN 서버로부터 획득 가능)
- TURN 서버의 IP와 포트 넘버(TURN 서버로부터 획득 가능)



### ICE(Interactive Connectivity Establishment)

- 두 개의 단말이 P2P 연결을 가능하게 하도록 최적의 경로를 찾아주는 프레임워크
- 이 모든 과정이 ICE라는 프레임워크 위에서 이루어짐



## SDP(Session Description Protocol)

**WebRTC에서 스트리밍 미디어의 해상도나 형식, 코덱 등의 멀티미디어 컨텐츠의 초기 인수를 설명하기 위해 채택한 프로토콜**

ex) 웹캠 비디오의 해상도, 오디오 전송, 수신 여부 등



제안 응답 모델을 갖고 있음(Offer/Answer)

제안 => 응답 => 각자의 피어가 수집한 ICE 후보 중 최적 경로를 결정하고 협상하는 프로세스 발생함

=> 기본적으로 필요한 모든 메타 데이터, IP 주소, 포트, 미디어 정보가 피어 간 합의 완료됨

피어 간 P2P 연결 설정 & 활성화 => 각 피어에 의해 로컬 데이터 스트림의 엔드포인트 생성

=> 양방향 통신 기술을 사용하여 최종적으로 데이터가 양방향으로 전송됨



## Tricle ICE

후보 교환 작업을 병렬 프로세스로 수행할 수 있게 만드는 역할.

두 개의 피어가 ICE 후보를 수집하고 교환하는 과정을 동기적 프로세스에서 비동기적 프로세스로 만드는 기술

각 피어에서 ICE 후보를 찾아내는 그 즉시 교환을 시작함.

=> 상호 간 연결 가능한 ICE를 보다 빨리 찾아낼 수 있음



## Signaling

![signaling](https://www.html5rocks.com/ko/tutorials/webrtc/infrastructure/jsep.png)

**RTCPeerConnection 통신에 사용할 프로토콜, 채널, 미디어 코덱 및 형식, 데이터 전송 방법, 라우팅 정보와 NAT 통과 방법을 포함한 통신 규격을 교환하기 위해 두 장치의 제어 정보를 교환하는 과정**



시그널링 서버를 직접 구축: 

- 웹 소켓(Web Socket)이나 서버 전송 이벤트(Server-sent Event) 방법 적용
- Polling 기법: 시그널링 정보를 조회할 수 있는 API를 만든 후 브라우저단에서 주기적으로 XHR을 요청

or

시그널링 서버를 제공해주는 솔루션 활용

- 아마존 Kinesis Video Stream
- 구글 AppRTC



## WebRTC의 한계

![tcp_udp](https://wormwlrm.github.io/img/posts/2021-01-24/5.png)

1. 브라우저 간 호환성

2. 시그널링 서버에 대한 명시적인 표준이 없음.

3. UDP 위에서 동작

   데이터를 빠르게 전송할 수는 있지만, 데이터 손실이 발생할 수 있음









###### 참고 사이트

https://wormwlrm.github.io/2021/01/24/Introducing-WebRTC.html